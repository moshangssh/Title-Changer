# Title-Changer 重构计划：消除代码重复

## 发现的问题

经过代码库分析，我们发现了以下几个代码重复的问题：

### 1. LinkTitleWidget 类重复定义

在两个文件中存在几乎相同的实现：
- `src/services/DecorationManager.ts`（119-137行）
- `src/views/editor-view.ts`（228-253行）

这两个类实现了相同的功能，但有略微不同的属性和方法。

### 2. 错误处理模式重复

- 多个服务中都有类似的 try-catch 结构
- 虽然有 `src/utils/error-helpers.ts` 提供了通用错误处理函数，但未被一致使用
- 在不同文件中的错误处理逻辑非常相似

### 3. DOM操作类似代码

- 在多个视图相关文件中（如 `editor-view.ts` 和 `explorer-view.ts`）有类似的DOM元素创建和操作代码
- 这些代码都在处理相似的逻辑，但未被提取为共享函数

### 4. 正则表达式处理

- `editor-view.ts` 和 `DecorationManager.ts` 中有处理 `\[\[(.*?)\]\]` 类似Wiki链接的重复逻辑
- 这些正则表达式和处理逻辑应该被提取到一个共享的工具类中

## 重构计划

### 阶段一：共享组件提取

#### 任务 1.1：提取 LinkTitleWidget 组件
- [ ] 创建 `src/components/widgets/LinkTitleWidget.ts` 文件
- [ ] 实现统一的 LinkTitleWidget 类，合并两个现有实现的功能
- [ ] 更新 `DecorationManager.ts` 使用新的共享组件
- [ ] 更新 `editor-view.ts` 使用新的共享组件
- [ ] 添加单元测试确保功能正常

#### 任务 1.2：提取 Wiki 链接处理逻辑
- [ ] 创建 `src/utils/wiki-link-processor.ts` 文件
- [ ] 实现 `extractWikiLinks`、`processWikiLinks` 等通用函数
- [ ] 更新 `DecorationManager.ts` 和 `editor-view.ts` 使用新工具
- [ ] 添加单元测试

### 阶段二：统一错误处理

#### 任务 2.1：优化错误处理工具
- [ ] 完善 `src/utils/error-helpers.ts` 中的工具函数
- [ ] 添加更多错误类别和处理策略
- [ ] 添加文档说明如何使用错误处理工具

#### 任务 2.2：统一使用错误处理工具
- [ ] 更新 `src/services/` 目录下所有服务使用统一错误处理
- [ ] 更新 `src/views/` 目录下所有视图使用统一错误处理
- [ ] 移除重复的错误处理代码

### 阶段三：DOM 操作工具化

#### 任务 3.1：创建 DOM 操作工具
- [ ] 创建 `src/utils/dom-helpers.ts` 文件
- [ ] 实现通用 DOM 元素创建和操作函数
- [ ] 添加单元测试

#### 任务 3.2：重构视图文件
- [ ] 更新 `editor-view.ts` 使用 DOM 操作工具
- [ ] 更新 `explorer-view.ts` 使用 DOM 操作工具
- [ ] 更新 `reading-view.ts` 使用 DOM 操作工具

### 阶段四：测试与验证

#### 任务 4.1：增加测试覆盖率
- [ ] 为新创建的工具和组件编写单元测试
- [ ] 确保测试覆盖率保持或提高

#### 任务 4.2：性能测试
- [ ] 测试重构前后的性能变化
- [ ] 确保没有引入性能退化

#### 任务 4.3：用户体验验证
- [ ] 验证所有功能在重构后正常工作
- [ ] 确保用户界面没有变化

## 实施优先级

1. 提取 LinkTitleWidget 组件（高优先级）
2. 统一错误处理（高优先级）
3. 提取 Wiki 链接处理逻辑（中优先级）
4. 创建 DOM 操作工具（中优先级）
5. 测试与验证（必需）

## 风险评估

| 风险 | 可能性 | 影响 | 缓解策略 |
|------|--------|------|----------|
| 功能退化 | 中 | 高 | 提高测试覆盖率，增加集成测试 |
| 性能下降 | 低 | 中 | 进行性能基准测试，确保不引入额外开销 |
| 重构时间过长 | 中 | 中 | 分阶段实施，优先解决高影响区域 |
| API 兼容性问题 | 低 | 高 | 保持公共 API 不变，逐步迁移内部实现 |

## 预期收益

- **代码可维护性提升**：消除代码重复，降低维护成本
- **错误处理一致性**：统一的错误处理流程，提高稳定性
- **代码复用度提高**：通过共享组件和工具函数提高代码复用
- **更容易理解的架构**：清晰的职责分离，降低学习成本
- **更容易扩展**：模块化设计使添加新功能更简单

## 结束标准

- 所有identified的代码重复已被消除
- 测试覆盖率不低于重构前
- 性能指标不低于重构前
- 所有现有功能正常工作 